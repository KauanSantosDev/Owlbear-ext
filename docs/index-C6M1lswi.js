import l from"https://cdn.jsdelivr.net/npm/@owlbear-rodeo/sdk@1.5.2/+esm";(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))f(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const g of i.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&f(g)}).observe(document,{childList:!0,subtree:!0});function _(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function f(n){if(n.ep)return;n.ep=!0;const i=_(n);fetch(n.href,i)}})();const C="chat-historia-medieval";async function I(){try{if(!await l.scene.isReady())throw new Error("Cena n√£o est√° pronta");const c=await l.scene.getMetadata();return Array.isArray(c[C])?c[C]:[]}catch(r){return console.warn("üîç loadChat: cena indispon√≠vel ou erro ao carregar:",r.message),[]}}async function v(r){try{if(!await l.scene.isReady())throw new Error("Cena n√£o est√° pronta");const _=await l.scene.getMetadata();await l.scene.setMetadata({..._,[C]:r})}catch(c){console.warn("üíæ saveChat: cena indispon√≠vel ou erro ao salvar:",c.message)}}async function E(r,c){if(await l.player.getRole()!=="GM")return;const n={...await l.scene.getMetadata(),[r]:c};await l.scene.setMetadata(n)}async function k(r){const _=r.replace(/\s*([+-])\s*(\d+)/g,"$1$2").trim().split(/\s+/);let f=0;const n=[],i=await l.scene.getMetadata(),g=i.__forcarCritico__===!0,w=i.__forcarErro__===!0;let b=!1;function M(s,t){if(b||s.length===0)return;const e=s.flatMap((d,u)=>d.rolls.map((p,y)=>({grupo:u,index:y})));if(e.length===0)return;const o=e[Math.floor(Math.random()*e.length)],a=s[o.grupo];a.rolls[o.index]=t==="critico"?"__CRITICO__":"__ERRO__",b=!0}const h=[];for(const s of _){const t=s.match(/^(\d+)#d(\d+)([+-]\d+)?$/i);if(t){const a=Math.min(parseInt(t[1],10),100),d=Math.min(parseInt(t[2],10),100),u=t[3]?parseInt(t[3],10):0;for(let p=0;p<a;p++){const y=1+Math.floor(Math.random()*d);h.push({notation:`1d${d}`,rolls:[y],bonus:u,faces:d})}continue}const e=s.match(/^(\d*)d(\d+)([+-]\d+)?$/i);if(e){const a=Math.min(parseInt(e[1]||"1",10),100),d=Math.min(parseInt(e[2],10),100),u=e[3]?parseInt(e[3],10):0,p=[];for(let y=0;y<a;y++)p.push(1+Math.floor(Math.random()*d));h.push({notation:`${a}d${d}${u?(u>0?"+":"")+u:""}`,rolls:p,bonus:u,faces:d});continue}const o=s.match(/^([+-]\d+)$/);if(o){const a=parseInt(o[1],10);h.push({notation:`${a>0?"+":""}${a}`,rolls:[],bonus:a,faces:0})}}g?M(h,"critico"):w&&M(h,"erro");for(const s of h){const t=s.rolls.map(o=>o==="__CRITICO__"?s.faces:o==="__ERRO__"?1:o),e=t.reduce((o,a)=>o+a,0)+s.bonus;f+=e,n.push({notation:s.notation,rolls:t,bonus:s.bonus,faces:s.faces})}return b&&await l.scene.setMetadata({__forcarCritico__:!1,__forcarErro__:!1}),n.length?{total:f,details:n}:null}async function T({mensagensDiv:r,entradaInput:c,enviarBtn:_}){let f=await I();b(f),l.scene.onMetadataChange(t=>{const e=t[C];if(!Array.isArray(e))return;const o=f.length;if(f=e,f.length>o)for(const a of f.slice(o))M(a,!0);else f.length<o&&s(()=>b(f))}),_.addEventListener("click",g),c.addEventListener("keydown",t=>{t.key==="Enter"&&g()});function n(t,e){const o={gold:{fg:"#ffd966",sh1:"rgba(255,255,224,0.4)",sh2:"rgba(255,215,0,0.4)",anim:!1},green:{fg:"#66ff66",sh1:"rgba(0,255,0,0.8)",sh2:"rgba(0,255,0,0.6)",anim:!0,key:"pulseGreen"},red:{fg:"#ff6666",sh1:"rgba(255,0,0,0.8)",sh2:"rgba(255,0,0,0.6)",anim:!0,key:"pulseRedLow"},blue:{fg:"#66ccff",sh1:"rgba(0,200,255,0.8)",sh2:"rgba(0,200,255,0.6)",anim:!0,key:"pulseBlue"}},a=o[e]||o.gold,d=a.anim?`animation: ${a.key} 1s ease-in-out infinite both;`:"";return`<span style="
            font-weight: bold;
            color: ${a.fg};
            text-shadow: 0 0 2px ${a.sh1}, 0 0 4px ${a.sh2};
            ${d}
        ">${t}</span>`}function i(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}async function g(){const t=c.value.trim();if(!t)return;c.value="";const e=t.replace(/\s*([+-])\s*(\d+)/g,"$1$2");for(const d of e.split(/\s+/)){const u=d.match(/^(\d+)#d(\d+)/i);if(u){const y=+u[1],m=+u[2];if(y>100){h("‚ùå M√°ximo 100 conjuntos.");return}if(m>100){h("‚ùå M√°ximo 100 faces.");return}}const p=d.match(/^(\d*)d(\d+)([+-]\d+)?$/i);if(p){const y=+p[1]||1,m=+p[2];if(y>100){h("‚ùå M√°ximo 100 dados.");return}if(m>100){h("‚ùå M√°ximo 100 faces.");return}}}const o=await k(e);if(o){const d=o.details.some(m=>m.rolls.includes(m.faces)),u=o.details.some(m=>m.rolls.includes(1)),p=d&&u?"blue":d?"green":u?"red":"gold",y=o.details.map(m=>{const $=n(m.notation,p),L=n(`[${m.rolls.join(",")}]`,p),x=m.bonus!==0?n(m.bonus>0?`+${m.bonus}`:`${m.bonus}`,p):"",R=m.rolls.length===1?` ‚áí ${n(m.rolls[0]+m.bonus,p)}`:"";return`> ${$} ‚Üí ${L}${x}${R}`});return/#d/i.test(e)||y.push(`> ${n("‚òÖ Total final: "+o.total,p)}`),w(y.join("<br>"),{high:d,low:u})}const a=await l.player.getRole();if(t.toLowerCase()==="/clear"&&a==="GM"){await v([]),s(()=>b([]));return}w(i(t),{high:!1,low:!1})}async function w(t,{high:e,low:o}){const a=await l.player.getRole(),u={nome:await l.player.getName(),role:a,texto:t,critical:e?"high":o?"low":null};f.push(u),M(u,!0),await v(f)}function b(t){r.innerHTML="";for(const e of t)M(e,!1);r.scrollTop=r.scrollHeight}function M(t,e){const o=document.createElement("div");o.className="mensagem",t.critical==="high"&&o.classList.add("critical-high"),t.critical==="low"&&o.classList.add("critical-low");const a=t.texto.includes("<br>");o.innerHTML=`
            ${t.nome?`
            <strong style="color:${t.role==="GM"?"#e74c3c":"#f1c40f"}">
            ${t.nome}:
            </strong> ${a?"<br>":" "}
            `:""}
         ${t.texto}
        `,r.appendChild(o),e&&(o.offsetWidth,o.classList.add("slide-in"),o.addEventListener("animationend",d=>{d.animationName==="slideInLeft"&&o.classList.remove("slide-in")})),r.scrollTop=r.scrollHeight}function h(t){const e=document.createElement("div");e.className="mensagem system",e.textContent=t,r.appendChild(e),r.scrollTop=r.scrollHeight}function s(t){const e=Array.from(r.children);e.forEach((o,a)=>{o.classList.remove("critical-high","critical-low","system"),setTimeout(()=>o.classList.add("wipe-out"),a*80)}),setTimeout(()=>{r.innerHTML="",t()},e.length*80+400)}}async function A({gmBtn:r,gmModal:c,gmClose:_}){if(await l.player.getRole()!=="GM")return;r.style.display="block",r.addEventListener("click",()=>{c.style.display=c.style.display==="block"?"none":"block"}),_.addEventListener("click",()=>{c.style.display="none"});const n=document.createElement("button");n.textContent="üí¨ Enviar Aviso",n.addEventListener("click",async()=>{const s=prompt("Digite o aviso:");if(!s)return;const t=await l.scene.getMetadata(),e=Array.isArray(t["chat-historia-medieval"])?t["chat-historia-medieval"]:[];e.push({nome:"",role:"GM",texto:`
                <div style="
                    font-family: 'MedievalSharp', cursive;
                    color: #f39c12;
                    font-size: 1.1em;
                    background: rgba(0, 0, 0, 0.4);
                    padding: 10px 12px;
                    margin: 8px 0;
                    border-left: 4px solid #f39c12;
                ">
                    ‚öúÔ∏è <b>${s}</b>
                </div>
            `,critical:null}),await v(e)});const i=document.createElement("button");i.textContent="üßπ Limpar Chat",i.addEventListener("click",async()=>{confirm("Tem certeza que deseja apagar TODO o chat para todos?")&&await v([])});const g=document.createElement("button");g.textContent="üéØ For√ßar Cr√≠tico",g.style.border="2px solid #fff8dc";const w=document.createElement("button");w.textContent="üí¢ For√ßar Erro",w.style.border="2px solid #fff8dc";async function b(){const t=(await l.scene.getMetadata()).__forcarCritico__===!0;g.style.background=t?"#66ff66":"#c0a060",g.style.color=t?"#000":"#3b2f0b"}async function M(){const t=(await l.scene.getMetadata()).__forcarErro__===!0;w.style.background=t?"#ff6666":"#c0a060",w.style.color=t?"#000":"#3b2f0b"}g.addEventListener("click",async()=>{const t=(await l.scene.getMetadata()).__forcarCritico__===!0;await E("__forcarCritico__",!t),await E("__forcarErro__",!1),b(),M()}),w.addEventListener("click",async()=>{const t=(await l.scene.getMetadata()).__forcarErro__===!0;await E("__forcarErro__",!t),await E("__forcarCritico__",!1),M(),b()}),l.scene.onMetadataChange(()=>{b(),M()}),b(),M();const h=c.querySelector(".gm-modal-content");h.appendChild(n),h.appendChild(g),h.appendChild(w),h.appendChild(i)}l.onReady(async()=>{const r=document.getElementById("mensagens"),c=document.getElementById("entrada"),_=document.getElementById("enviar"),f=document.getElementById("gm-btn"),n=document.getElementById("gm-modal"),i=document.getElementById("gm-modal-close");await T({mensagensDiv:r,entradaInput:c,enviarBtn:_}),A({gmBtn:f,gmModal:n,gmClose:i})});
